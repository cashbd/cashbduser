<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - CASHBD</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <div class="marquee" id="noticeBoard">Welcome to CASHBD - স্বাগতম</div>

        <!-- ================= BALANCE CARD WITH STATS ================= -->
        <div class="balance-card card">
            <div style="color: var(--text-mute); margin-top: 10px;">Total Balance</div>
            <div class="balance-amount" style="margin-bottom: 10px;">৳ <span id="uBal">0.00</span></div>
            
            <!-- Divider -->
            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0;"></div>

            <!-- Total Deposit & Withdraw Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <!-- Total Deposit -->
                <div style="text-align: center;">
                    <div style="font-size: 0.8rem; color: #ccc;">Total Deposit - জমা</div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--green); margin-top: 5px;">
                        ৳ <span id="tDepMain">0</span>
                    </div>
                </div>
                <!-- Total Withdraw -->
                <div style="text-align: center; border-left: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 0.8rem; color: #ccc;">Total Withdraw - উত্তোলন</div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--red); margin-top: 5px;">
                        ৳ <span id="tWithMain">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= SECONDARY STATS ================= -->
        <div class="card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; text-align:center; border: 1px solid #333;">
                    <i class="fas fa-rocket" style="color: var(--accent); font-size: 1.2rem; margin-bottom: 5px;"></i>
                    <div style="font-size: 0.8rem; color:#888">Active Plans</div>
                    <div id="nPlans" style="font-size:1.2rem; font-weight:bold; color: white;">0</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; text-align:center; border: 1px solid #333;">
                    <i class="fas fa-gift" style="color: #e91e63; font-size: 1.2rem; margin-bottom: 5px;"></i>
                    <div style="font-size: 0.8rem; color:#888">Total Bonus</div>
                    <div style="font-size:1.2rem; font-weight:bold; color: white;">৳ <span id="tBonus">0</span></div>
                </div>
            </div>
        </div>

        <!-- ================= RECENT ACTIVITY ================= -->
        <div class="card">
            <h3 style="color:var(--primary); border-bottom:1px solid #333; padding-bottom:5px; display:flex; justify-content:space-between;">
                <span>Recent Activity</span>
                <a href="deposit.html" style="font-size:0.8rem; color:var(--accent); text-decoration:none;">See All</a>
            </h3>
            <div id="recentActivity" style="font-size:0.85rem; margin-top:10px; min-height:50px;">
                <div style="text-align:center; padding: 20px; color: #555;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <div class="navbar">
        <a href="dashboard.html" class="nav-item active"><i class="fas fa-home"></i>Home</a>
        <a href="plans.html" class="nav-item"><i class="fas fa-rocket"></i>Plans</a>
        <a href="deposit.html" class="nav-item"><i class="fas fa-wallet"></i>Wallet</a>
        <a href="referral.html" class="nav-item"><i class="fas fa-users"></i>Ref</a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user"></i>Profile</a>
    </div>

    <div id="toast"></div>
    <script src="firebase.js"></script>
    <script src="script.js"></script>
    <script>
        auth.onAuthStateChanged(user => {
            if(user) {
                // 1. User Info & Active Plans
                db.ref('users/' + user.uid).on('value', snap => {
                    const u = snap.val();
                    if(!u) return;

                    document.getElementById('uBal').innerText = (u.balance || 0).toFixed(2);
                    
                    // Calculate Bonus (Simple field if exists, or 0)
                    document.getElementById('tBonus').innerText = (u.bonus || 0).toFixed(0);

                    // Count Active Plans
                    let activeCount = 0;
                    if(u.plans) {
                        Object.values(u.plans).forEach(p => {
                            if(p.activeUntil > Date.now()) activeCount++;
                        });
                    }
                    document.getElementById('nPlans').innerText = activeCount;
                });

                // 2. Global Notice
                db.ref('settings/notice').on('value', snap => {
                    if(snap.val()) document.getElementById('noticeBoard').innerText = snap.val();
                });

                // 3. Calculate Totals & Recent History
                Promise.all([
                    db.ref('deposits').orderByChild('userId').equalTo(user.uid).once('value'),
                    db.ref('withdrawals').orderByChild('userId').equalTo(user.uid).once('value')
                ]).then(snapshots => {
                    const deposits = [];
                    const withdrawals = [];
                    
                    let totalDepSum = 0;
                    let totalWithSum = 0;

                    // Process Deposits
                    snapshots[0].forEach(c => {
                        const d = c.val();
                        deposits.push({...d, type: 'Deposit'});
                        if(d.status === 'approved') {
                            totalDepSum += parseFloat(d.amount);
                        }
                    });

                    // Process Withdrawals
                    snapshots[1].forEach(c => {
                        const w = c.val();
                        withdrawals.push({...w, type: 'Withdraw'});
                        if(w.status === 'approved') {
                            totalWithSum += parseFloat(w.amount);
                        }
                    });

                    // UPDATE TOTALS ON SCREEN
                    document.getElementById('tDepMain').innerText = totalDepSum;
                    document.getElementById('tWithMain').innerText = totalWithSum;

                    // Merge & Sort History (Last 5 items)
                    const combined = [...deposits, ...withdrawals].sort((a, b) => new Date(b.date) - new Date(a.date));
                    const recent = combined.slice(0, 5); 

                    const container = document.getElementById('recentActivity');
                    container.innerHTML = '';

                    if(recent.length === 0) {
                        container.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">No transactions yet.</div>';
                    } else {
                        recent.forEach(item => {
                            const isDep = item.type === 'Deposit';
                            const color = item.status === 'approved' ? 'var(--green)' : (item.status === 'rejected' ? 'var(--red)' : 'var(--accent)');
                            const icon = isDep ? 'fa-arrow-down' : 'fa-arrow-up';
                            const iconBg = isDep ? 'rgba(0, 106, 78, 0.2)' : 'rgba(244, 42, 65, 0.2)';
                            const iconColor = isDep ? '#00ff9d' : '#ff4d4d';
                            
                            container.innerHTML += `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #222;">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <div style="background:${iconBg}; padding:10px; border-radius:50%; color:${iconColor}; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;">
                                        <i class="fas ${icon}"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight:bold; font-size: 0.9rem;">${item.type}</div>
                                        <div style="font-size:0.75rem; color:#777;">${new Date(item.date).toLocaleDateString()}</div>
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-weight:bold; font-size: 1rem;">৳${item.amount}</div>
                                    <div style="font-size:0.75rem; color:${color}; text-transform:capitalize;">${item.status}</div>
                                </div>
                            </div>`;
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>